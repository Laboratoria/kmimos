:css
  #license_terms {
    overflow-y: scroll;
  }

= render partial: 'error_messages'
%div(ng-app="bookings_module")
  .container.content.mh-630(ng-controller = "BookingsController")
    = simple_nested_form_for(@booking)  do |f|
      %input{value: @provider.id}(name="provider_id" type="hidden")
      .row
        .col-md-12
          %h2.text-center.mt-35 Datos de la reserva
          %br

      .row
        .col-md-2
        .col-md-3
          = image_tag(@provider.avatar, width: '200px')
        .col-md-5
          %h2= @provider
          %h4.text-gray.light
            %small.text-black.bold Precio:
            = "#{current_country.currency} #{ 1.2 * (@provider.rates.minimum(:price))} noche"
          - @provider.locations.group_by(&:state_id).each do |k, state|
            %b= state.first.state
            %br
            %span.text-gray= state.map(&:name).join(", ")
      %br
      .row
        .col-md-2
        .col-md-8
          %h3.text-gray.mb-14 Genera tu reserva:
      .row.booking-container
        .col-md-2
        .col-md-8.mt-21.mb-42
          %br
          %br
          .row#datepair
            .col-md-2
              Llegada
              =f.input :start_date, as: :string, label: false, input_html: {class: "date start datepicker_min", 'ng-model': 'minDate', 'ng-change': 'get_diff_dates()'}
            .col-md-4
              Horas
              =f.input :pickup_time, :as => :time, label: false 
            .col-md-2
              Salida
              =f.input :end_date, as: :string, label: false, input_html: {class: "date end datepicker_max", 'ng-model': 'maxDate', 'ng-change': 'get_diff_dates()'}
            .col-md-4
              Hora
              =f.input :dropoff_time, :as => :time, label: false 

          .row
            .col-md-12
              .panel.panel-primary
                .panel-body.line-regular
                  %p Añade a tu mascota a la reserva del tiempo de estadía que selecciones.
                  .form-group.row(ng-repeat="pet in pets_booked")
                    .row.pd-0.border-bottom
                      .col-md-3 Nombre:
                      .col-md-6
                        %select.form-control{name: "booking[booked_pets_attributes][][pet_id]"}(ng-model= "pet.pet_id"  ng-change="update_pets(#{@provider.id})")
                          -current_user.pets.each do |pet|
                            %option{value: pet.id}= pet
                      .col-md-2 $ {{ pet.price }} MXN
                      .col-md-1
                        %a(ng-click="deletePet(pet)" href="#") X
                  %a.btn.btn-primary(ng-click="add_pet()") Quiero agregar a mi mascota
                  .row.mt-35.mb-14
                    %label Información Adicional
                  .form-group.row
                    .col-md-12
                      %p Dirección de Recojo
                      = f.input :address, class: "form-control", label: false, as: :text, input_html: { value: current_user.address }
                  .form-group.row
                    .col-md-12
                      %p ¿Necesitas que sepamos algo mas de tu perrito? (Ej: Necesita medicamentos, no convive con otros perros, sale a pasear 3 veces al dia, etc)
                      = f.input :user_message, label: false, as: :text, class: "form-control"

          %hr.hr-gray/
          %br
          %h4 ¿Quieres que pasen a recoger a tu perrito a tu casa? ¿Quieres que lo bañen? Checa estos servicios adicionales
          %br
          %p Kmimos te ofrece servicios adicionales para tu mascota, puedes adquirirlos independientemente de tu reserva.
          .panel-body
            .form-group.row(ng-repeat="serv in services_booked")
              .row.border-bottom
                .col-md-3 Servicio: 
                .col-md-3
                  %select.form-control.bkd_srv{name: "booking[booked_services_attributes][][service_id]"}(ng-model= "serv.service_id" ng-change="update_services(#{@provider.id})")
                    -@provider.services.uniq.each do |se|
                      %option{value: se.id}= se
                .col-md-3
                  %select.form-control.bkd_pt{name: "booking[booked_services_attributes][][pet_id]"}(ng-model= "serv.pet_id" ng-change="update_services(#{@provider.id})")
                    -current_user.pets.each do |pet|
                      %option{value: pet.id}= pet
                .col-md-2 $ {{serv.price}}  MXN
                .col-md-1
                  %a(ng-click="deleteServ(serv)" href="#") X
            %center
              %a.btn.btn-primary.add_srv_btn(ng-click="add_service()") Agregar Servicio
          .panel-heading
            %hr.hr-gray/
          .panel-body
          = f.input :total, as: :hidden, input_html: {value: "{{services_booked_total * 1.2 + pets_booked_total * 1.2}}"}
          .table
            %div(ng-if="parseInt(services_booked_total) != 0")
              %h4 Costos del servicio de estadia
              %table(width="100%")
                %thead
                  %th Mascota
                  %th Dias
                  %th.total Precio
                  %th.total SubTotal
                %tbody
                  %tr(ng-repeat="pet in pets_booked")
                    %td {{ pet.pet_name }}
                    %td {{ diff }}
                    %td.total $ {{ pet.price | number:2 }} MXN
                    %td.total $ {{ diff * pet.price | number:2 }} MXN
                %tfoot
                  %tr
                    %th.total(colspan=3) SUBTOTAL :
                    %th.total $ {{ pets_booked_total | number:2 }}  MXN
                  %tr
                    %th.total(colspan=3) BENEFICIOS KMIMOS :
                    %th.total $ {{ pets_booked_total * 0.2 | number:2 }}  MXN
                  %tr
                    %th.total(colspan=3) TOTAL :
                    %th.total $ {{ pets_booked_total * 1.2 | number:2 }}  MXN
            %div(ng-if="parseInt(services_booked_total) != 0")
              %h4 Costos de los servicios adicionales
              %table(width="100%")
                %thead
                  %th Mascota
                  %th Servicio
                  %th.total Precio
                %tbody
                  %tr(ng-repeat="serv in services_booked")
                    %td {{ serv.pet_name }}
                    %td {{ serv.service_name }}
                    %td.total $ {{ serv.price | number:2 }} MXN
                %tfoot
                  %tr
                    %th.total(colspan=2) SUBTOTAL :
                    %th.total $ {{ services_booked_total | number:2 }}  MXN
                  %tr
                    %th.total(colspan=2) BENEFICIOS KMIMOS :
                    %th.total $ {{ services_booked_total * 0.2 | number:2 }}  MXN
                  %tr
                    %th.total(colspan=2) TOTAL :
                    %th.total $ {{ services_booked_total * 1.2 | number:2 }}  MXN
          .panel-body
            = render partial: 'terms', locals: {f: f}

            .form-group.row
              .col-md-12
                %center
                  = link_to 'Reservar', '#myModal', 'data-toggle' => 'modal', :class => "btn grey-button form-control mt-21"

          %div
            %h5 (*) Confirmaremos tu reserva en un periodo de 24 horas, es posible que pueda haber un cambio. Si asi sucede nos contactaremos contigo para informarte y darte la mejor solucion.

:javascript

  var preselect_services =[]

- @services.each do |service|
  :javascript
    setTimeout(function(){
      $('.add_srv_btn').click();
      preselect_services.push("#{service.id}")
      $('.bkd_srv').each(function(index){
        $(this).val(preselect_services[index]);
      });
    }, 1000);

:javascript


  $('.datepicker_min').datepicker();

  $('.datepicker_max').datepicker();


  setTimeout(function(){

    $('.datepicker_max').datepicker("setDate", "#{session[:to_date]}");

    $('.datepicker_min').datepicker("setDate", "#{session[:from_date] }");


    $('.datepicker_max').change();
    $('.datepicker_min').change();

  }, 1000);

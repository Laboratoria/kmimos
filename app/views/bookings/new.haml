:css
  #license_terms {
    overflow-y: scroll;
  }

= render partial: 'error_messages'
= simple_nested_form_for(@booking)  do |f|
  %div(ng-app="bookings_module")
    .container.content.mh-630(ng-controller = "BookingsController")
      %input{value: @provider.id}(name="provider_id" type="hidden")
      .row
        .col-md-12
          %h2.text-center.mt-35 Datos de la reserva
          %br
      .row
        .col-md-2
        .col-md-3
          = image_tag(@provider.avatar, width: '200px')
        .col-md-5
          %h3= @provider
          %h4.text-gray.light
            %small.text-black.bold Precio:
            = "#{current_country.currency} #{ 1.2 * (@provider.rates.where("coalesce(price,0) > 0").minimum(:price))} noche"
          %p= @provider.description
      %br
      .row
        .col-md-2.p-0
        .col-md-8.p-0
          %h2.text-gray.mb-14.p-0 Genera tu reserva:
      .row.booking-container
        .col-md-2.p-0
        .col-md-8.mb-42p.-0
          %br
          .row
            .col-md-12
              %h3.text-gray 1. Fecha de las reserva:
              %p Selecciona una fecha válida para activar el botón de reserva
          .row#datepair
            .col-md-3
              Llegada
              =f.input :start_date, as: :string, label: false, input_html: {class: "date start datepicker_min", 'ng-model': 'minDate', 'ng-change': 'get_diff_dates()'}
            .col-md-3
              Horas
              =f.input :pickup_time, :as => :time, label: false, :minute_step => 15
            .col-md-3
              Salida
              =f.input :end_date, as: :string, label: false, input_html: {class: "date end datepicker_max", 'ng-model': 'maxDate', 'ng-change': 'get_diff_dates()'}
            .col-md-3
              Hora
              =f.input :dropoff_time, :as => :time, label: false, :minute_step => 15
          .row
            .col-md-12
              %h3.text-gray 2. Selecciona tu mascota
              .panel.panel-primary
                - provider_pet_sizes = @provider.rates.where("coalesce(price,0) > 0").map{|rate| rate.size_id}
                - user_pet_sizes = current_user.pets.map{|pet| pet.size_id}
                - if (provider_pet_sizes.any?{|pet_size| user_pet_sizes.include?(pet_size)})
                  %p Añade a tu mascota a la reserva del tiempo de estadía que selecciones. Recuerda agregar al menos una mascota para que se active el botón de reserva
                  .row(ng-repeat="pet in pets_booked")
                    .row.pd-0.border-bottom.add_pet
                      .col-md-3 Nombre:
                      .col-md-6
                        %select.form-control{name: "booking[booked_pets_attributes][][pet_id]"}(ng-model= "pet.pet_id" ng-change="update_pets(#{@provider.id})")
                          -current_user.pets.each do |pet|
                            %option{value: pet.id}= pet
                      .col-md-2 $ {{ pet.price }} MXN
                      .col-md-1
                        %a(ng-click="deletePet(pet)" href="#") Eliminar
                  - if !current_user.pets.empty?
                    %a.btn.btn-primary(ng-click="add_pet()") Agregar otra mascota
                  - else
                    %p Aún no tienes ninguna mascota registrada anda a tu perfil para agregar una.
                  .row.mt-35.mb-14
                - else
                  %p Este cuidador no tiene disponibilidad para cuidar el tamaño de perro con el que usted cuenta.
                %h3.text-gray 3. Información Adicional
                .form-group.row
                  .col-md-12.p-0
                    %p Dirección de Recojo
                    = f.input :address, class: "form-control", label: false, as: :text, input_html: { value: current_user.address }
                .form-group.row
                  .col-md-12.p-0
                    %p ¿Necesitas que sepamos algo más de tu perrito? (Ej: Necesita medicamentos, no convive con otros perros, sale a pasear 3 veces al día, etc)
                    = f.input :user_message, label: false, as: :text, class: "form-control"

          - if !@provider.additional_services.empty?
            %hr.hr-gray-booking/
            .row
              .col-md-12
                %h3 4. Servicios Adicional
                %p Kmimos te ofrece servicios adicionales para tu mascota, puedes adquirirlos independientemente de tu reserva.
                %br
                .panel-body
                  .row.border-bottom.add_service.m-0(ng-repeat="serv in services_booked")
                    .col-md-3 Servicio: 
                    .col-md-3
                      %select.form-control.bkd_srv{name: "booking[booked_services_attributes][][service_id]"}(ng-model= "serv.service_id" ng-change="update_services(#{@provider.id})")
                        -@provider.services.uniq.each do |se|
                          %option{value: se.id}= se
                    .col-md-3
                      %select.form-control.bkd_pt{name: "booking[booked_services_attributes][][pet_id]"}(ng-model= "serv.pet_id" ng-change="update_services(#{@provider.id})")
                        -current_user.pets.each do |pet|
                          %option{value: pet.id}= pet
                    .col-md-2 $ {{serv.price}}  MXN
                    .col-md-1
                      %a(ng-click="deleteServ(serv)" href="#") Eliminar
                %center
                  %a.btn.btn-primary.add_srv_btn(ng-click="add_service()") Agregar Servicio
          %hr.hr-gray-booking/
          .panel-body
          = f.input :total, as: :hidden, input_html: {value: "{{services_booked_total * 1.2 + pets_booked_total * 1.2}}"}
          .table.plr-14
            %div(ng-if="parseInt(services_booked_total) != 0")
              %h4 Costos del servicio de estadia
              %table(width="100%")
                %thead
                  %th Mascota
                  %th Dias
                  %th.total Precio
                  %th.total SubTotal
                %tbody
                  %tr(ng-repeat="pet in pets_booked")
                    %td {{ pet.pet_name }}
                    %td {{ diff }}
                    %td.total $ {{ pet.price | number:2 }} MXN
                    %td.total $ {{ diff * pet.price | number:2 }} MXN
                %tfoot
                  %tr
                    %th.total(colspan=3) SUBTOTAL :
                    %th.total $ {{ pets_booked_total | number:2 }}  MXN
                  %tr
                    %th.total(colspan=3) BENEFICIOS KMIMOS :
                    %th.total $ {{ pets_booked_total * 0.2 | number:2 }}  MXN
                  %tr
                    %th.total(colspan=3) TOTAL :
                    %th.total $ {{ pets_booked_total * 1.2 | number:2 }}  MXN
            %div(ng-if="parseInt(services_booked_total) != 0")
              %h4 Costos de los servicios adicionales
              %table(width="100%")
                %thead
                  %th Mascota
                  %th Servicio
                  %th.total Precio
                %tbody
                  %tr(ng-repeat="serv in services_booked")
                    %td {{ serv.pet_name }}
                    %td {{ serv.service_name }}
                    %td.total $ {{ serv.price | number:2 }} MXN
                %tfoot
                  %tr
                    %th.total(colspan=2) SUBTOTAL :
                    %th.total $ {{ services_booked_total | number:2 }}  MXN
                  %tr
                    %th.total(colspan=2) BENEFICIOS KMIMOS :
                    %th.total $ {{ services_booked_total * 0.2 | number:2 }}  MXN
                  %tr
                    %th.total(colspan=2) TOTAL :
                    %th.total $ {{ services_booked_total * 1.2 | number:2 }}  MXN
          .panel-body
            .form-group.row
              .col-md-12
                %center
                  = link_to 'Reservar', '#myModal', :class => "btn grey-button form-control mt-21", 'ng-show' => 'pets_booked_total > 0 || services_booked_total > 0', 'ng-click' => 'validate_submit()'

          %div
            %h5 (*) Confirmaremos tu reserva en un período de 24 horas, es posible que pueda haber un cambio. Si así sucede nos contactaremos contigo para informarte y darte la mejor solución.
  = render partial: 'terms', locals: {f: f}

- if Rails.env.production?
  :javascript
    mixpanel.track("Inicio reserva",{
       "id_cuidador": #{@provider.id},
       "nombre_cuidador": "#{@provider.name}",
       "apellido_cuidador": "#{@provider.last_name_1}"
    });

- to_date_r = Date.parse(session[:to_date])
- from_date_r = Date.parse(session[:from_date])

:javascript
  var preselect_services =[]
- @services.each do |service|
  :javascript
    setTimeout(function(){
      $('.add_srv_btn').click();
      preselect_services.push("#{service.id}");
      $('.bkd_srv').each(function(index){
        $(this).val(preselect_services[index]);
        angular.element($(this)).triggerHandler('change');
      });
    }, 1000);

:javascript
  $('.datepicker_min').datepicker({ 
    dateFormat: 'yy-mm-dd',
    minDate: new Date()
  });
  
  $('.datepicker_max').datepicker({ 
    dateFormat: 'yy-mm-dd',
    minDate: new Date()
  });
  
  setTimeout(function(){
    var to_date = new Date(#{to_date_r.strftime('%Y')}, #{to_date_r.strftime('%m').to_i - 1} , #{to_date_r.strftime('%d')});
    $('.datepicker_max').datepicker("setDate", to_date);
    var from_date = new Date(#{from_date_r.strftime('%Y')}, #{from_date_r.strftime('%m').to_i - 1}, #{from_date_r.strftime('%d')});
    $('.datepicker_min').datepicker("setDate", from_date);
    $('.datepicker_max').change();
    $('.datepicker_min').change();
  }, 1000);